# 微信登录功能部署说明 - 完整版

## 概述
本文档说明如何为时间赎回器微信小程序配置真正的微信登录功能，实现用户身份标识的获取。

## 功能特性
- ✅ 真正的微信登录流程（遵循官方规范）
- ✅ 获取用户唯一标识（openid）
- ✅ 自动降级到模拟登录（服务器不可用时）
- ✅ 登录状态管理和过期处理
- ✅ 本地数据存储和同步

## 微信登录流程（官方规范）

### 1. 小程序端流程
```
wx.login() → 获取临时登录凭证code → 发送到后端服务器
```

### 2. 服务器端流程
```
接收code → 调用auth.code2Session → 获取openid/session_key → 返回用户标识
```

### 3. 完整时序图
```
小程序                   服务器                   微信API
  |                        |                        |
  |-- wx.login() -------->|                        |
  |<-- code -------------|                        |
  |                        |                        |
  |-- code --------------->|                        |
  |                        |-- code2Session ------>|
  |                        |<-- openid/session_key-|
  |                        |                        |
  |<-- openid ------------|                        |
```

## 部署步骤

### 1. 后端服务器部署

#### 1.1 安装依赖
```bash
# 安装Node.js依赖
npm install

# 或者使用yarn
yarn install
```

#### 1.2 配置微信小程序信息
编辑 `server-example.js` 文件，替换以下配置：
```javascript
const APPID = 'your-appid'; // 替换为您的微信小程序AppID
const SECRET = 'your-secret'; // 替换为您的微信小程序AppSecret
```

#### 1.3 启动服务器
```bash
# 开发模式（自动重启）
npm run dev

# 生产模式
npm start
```

服务器将在 `http://localhost:3000` 启动。

### 2. 微信小程序配置

#### 2.1 更新服务器地址
在 `pages/settings/settings.js` 中更新服务器地址：
```javascript
// 将此处替换为您的服务器地址
const serverUrl = 'https://your-server.com/api/login';
```

#### 2.2 配置服务器域名
在微信开发者工具中：
1. 项目设置 → 开发设置
2. 服务器域名 → request合法域名
3. 添加您的服务器域名（如：`https://your-server.com`）

### 3. 微信公众平台配置

#### 3.1 获取AppID和AppSecret
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 选择您的小程序
3. 开发 → 开发管理 → 开发设置
4. 复制AppID和AppSecret

#### 3.2 配置服务器域名
1. 开发 → 开发管理 → 开发设置
2. 服务器域名 → request合法域名
3. 添加您的后端服务器域名

## 功能说明

### 登录类型
1. **微信登录**：通过微信官方接口获取真实openid
2. **模拟登录**：当服务器不可用时自动降级

### 登录状态管理
- **登录有效期**：7天
- **自动过期**：超过有效期自动清除登录状态
- **状态显示**：区分微信登录和模拟登录

### 数据存储
- 用户openid：`wx.setStorageSync('openid', openid)`
- 用户昵称：`wx.setStorageSync('userName', nickName)`
- 用户头像：`wx.setStorageSync('userAvatarUrl', avatarUrl)`
- 登录时间：`wx.setStorageSync('loginTime', timestamp)`
- 登录类型：`wx.setStorageSync('isMockLogin', boolean)`

## 安全注意事项

### 1. 服务器端安全
- **AppSecret保密**：不要在客户端代码中暴露AppSecret
- **session_key保护**：不要将session_key下发到小程序端
- **HTTPS协议**：生产环境必须使用HTTPS
- **数据验证**：验证请求的合法性

### 2. 小程序端安全
- **code一次性**：临时登录凭证只能使用一次
- **本地存储**：敏感信息仅存储在本地
- **过期处理**：定期清理过期的登录状态

## 测试方法

### 1. 本地测试
```bash
# 启动后端服务器
npm start

# 在微信开发者工具中测试
# 确保已配置正确的服务器域名
```

### 2. 真机测试
1. 部署后端服务器到云服务器
2. 配置HTTPS证书
3. 在微信公众平台配置服务器域名
4. 使用真机预览功能测试

### 3. 模拟登录测试
- 断开网络连接
- 点击登录按钮
- 验证是否自动降级到模拟登录

## 常见问题

### Q1: 登录失败怎么办？
A1: 检查以下几点：
- AppID和AppSecret是否正确
- 服务器域名是否已配置
- 后端服务器是否正常运行
- 网络连接是否正常

### Q2: 为什么使用模拟登录？
A2: 模拟登录在以下情况自动启用：
- 后端服务器不可用
- 网络连接失败
- 域名配置错误

### Q3: 如何区分真实登录和模拟登录？
A3: 通过以下方式区分：
- 登录状态显示：✅ 微信登录 / ✅ 模拟登录
- 用户标识：真实openid / mock_开头的标识
- 数据存储：isMockLogin标记

### Q4: 登录会过期吗？
A4: 是的，登录状态会在7天后自动过期：
- 自动清除登录状态
- 需要重新登录
- 保护用户数据安全

## 更新日志

### v1.5.0 (2025-01-XX)
- ✅ 实现真正的微信登录流程
- ✅ 遵循微信官方登录规范
- ✅ 添加登录状态过期处理
- ✅ 区分真实登录和模拟登录
- ✅ 完善安全机制

## 技术支持

如有问题，请联系：
- 邮箱：iancoding@163.com
- 项目地址：https://github.com/ianlinkstudy/Time-Redemption.git

---

**注意**：请确保遵循微信小程序开发规范和相关法律法规。 