# 微信登录功能部署说明

## 概述
本文档说明如何为时间赎回器微信小程序配置微信登录功能，实现用户头像和昵称的自动获取。

## 功能特性
- ✅ 微信登录获取用户openid
- ✅ 自动获取微信头像和昵称
- ✅ 本地数据存储和同步
- ✅ 登录状态管理
- ✅ 手动设置备选方案

## 部署步骤

### 1. 后端服务器部署

#### 1.1 安装依赖
```bash
# 安装Node.js依赖
npm install

# 或者使用yarn
yarn install
```

#### 1.2 配置微信小程序信息
编辑 `server-example.js` 文件，替换以下配置：
```javascript
const APPID = 'your-appid'; // 替换为您的微信小程序AppID
const SECRET = 'your-secret'; // 替换为您的微信小程序AppSecret
```

#### 1.3 启动服务器
```bash
# 开发模式（自动重启）
npm run dev

# 生产模式
npm start
```

服务器将在 `http://localhost:3000` 启动。

### 2. 微信小程序配置

#### 2.1 更新服务器地址
在 `pages/settings/settings.js` 中更新服务器地址：
```javascript
// 将此处替换为您的服务器地址
const serverUrl = 'https://your-server.com/api/login';
```

#### 2.2 配置服务器域名
在微信开发者工具中：
1. 项目设置 → 开发设置
2. 服务器域名 → request合法域名
3. 添加您的服务器域名（如：`https://your-server.com`）

### 3. 微信公众平台配置

#### 3.1 获取AppID和AppSecret
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 选择您的小程序
3. 开发 → 开发管理 → 开发设置
4. 复制AppID和AppSecret

#### 3.2 配置服务器域名
1. 开发 → 开发管理 → 开发设置
2. 服务器域名 → request合法域名
3. 添加您的后端服务器域名

## 功能说明

### 登录流程
1. 用户点击"微信登录获取用户信息"
2. 小程序调用 `wx.login()` 获取code
3. 将code发送到后端服务器
4. 后端调用微信接口获取openid
5. 返回用户信息给小程序
6. 小程序保存用户信息到本地存储

### 用户信息获取
- **头像获取**：使用微信最新的 `button open-type="chooseAvatar"`
- **昵称获取**：通过输入框让用户手动输入
- **登录状态**：显示当前登录状态和openid

### 数据存储
- 用户头像：`wx.setStorageSync('userAvatarUrl', avatarUrl)`
- 用户昵称：`wx.setStorageSync('userName', nickName)`
- 用户openid：`wx.setStorageSync('openid', openid)`

## 测试方法

### 1. 本地测试
```bash
# 启动后端服务器
npm start

# 在微信开发者工具中测试
# 确保已配置正确的服务器域名
```

### 2. 真机测试
1. 部署后端服务器到云服务器
2. 配置HTTPS证书
3. 在微信公众平台配置服务器域名
4. 使用真机预览功能测试

## 常见问题

### Q1: 登录失败怎么办？
A1: 检查以下几点：
- AppID和AppSecret是否正确
- 服务器域名是否已配置
- 后端服务器是否正常运行
- 网络连接是否正常

### Q2: 无法获取用户头像和昵称？
A2: 根据微信最新政策：
- 头像需要通过 `button open-type="chooseAvatar"` 获取
- 昵称需要用户手动输入
- 无法通过API直接获取用户信息

### Q3: 后端服务器部署在哪里？
A3: 推荐使用以下云服务：
- 腾讯云
- 阿里云
- 华为云
- 微信云开发

## 安全注意事项

1. **AppSecret保密**：不要在客户端代码中暴露AppSecret
2. **HTTPS协议**：生产环境必须使用HTTPS
3. **数据验证**：后端需要验证请求的合法性
4. **错误处理**：妥善处理各种异常情况

## 更新日志

### v1.4.0 (2025-01-XX)
- ✅ 新增微信登录功能
- ✅ 支持openid获取
- ✅ 优化用户界面
- ✅ 添加登录状态显示
- ✅ 完善错误处理

## 技术支持

如有问题，请联系：
- 邮箱：iancoding@163.com
- 项目地址：https://github.com/ianlinkstudy/Time-Redemption.git

---

**注意**：请确保遵循微信小程序开发规范和相关法律法规。 